// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SubscriptionTier {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum EmploymentType {
  FULL_TIME
  CONTRACT
  PART_TIME
}

enum PayrollStatus {
  DRAFT
  PROCESSED
  REMITTED
}

enum UserRole {
  OWNER
  ACCOUNTANT
  EMPLOYEE
}

model Company {
  id                    String    @id @default(uuid())
  name                  String
  tin                   String?  @unique @db.VarChar(10)
  email                 String
  phone                 String?
  address               String?
  employee_count        Int       @default(0)
  subscription_tier     SubscriptionTier @default(FREE)
  subscription_expires_at DateTime?
  trial_ends_at         DateTime?
  tcc_number            String?
  tcc_issue_date        DateTime?
  tcc_expiry_date       DateTime?
  tcc_document_url      String?
  created_at            DateTime  @default(now())
  updated_at            DateTime  @updatedAt

  users                 User[]
  employees             Employee[]
  payroll_runs          PayrollRun[]
  
  @@index([email])
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  role      UserRole @default(OWNER)
  company_id String?
  company   Company? @relation(fields: [company_id], references: [id], onDelete: Cascade)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([email])
  @@index([company_id])
}

model Employee {
  id                  String          @id @default(uuid())
  company_id          String
  company             Company         @relation(fields: [company_id], references: [id], onDelete: Cascade)
  full_name           String
  tin                 String          @db.VarChar(10)
  email               String?
  phone               String?
  basic_salary        Decimal         @db.Decimal(12, 2)
  housing_allowance   Decimal         @default(0) @db.Decimal(12, 2)
  transport_allowance Decimal        @default(0) @db.Decimal(12, 2)
  other_allowances    Decimal         @default(0) @db.Decimal(12, 2)
  employment_type     EmploymentType  @default(FULL_TIME)
  state_of_residence  String?
  start_date          DateTime
  is_active           Boolean         @default(true)
  whatsapp_number     String?
  created_at          DateTime        @default(now())
  updated_at          DateTime        @updatedAt

  payslips            EmployeePayslip[]

  @@index([company_id])
  @@index([email])
  @@index([tin])
}

model PayrollRun {
  id          String        @id @default(uuid())
  company_id  String
  company     Company       @relation(fields: [company_id], references: [id], onDelete: Cascade)
  month       Int           // 1-12
  year        Int
  status      PayrollStatus @default(DRAFT)
  total_gross Decimal       @db.Decimal(15, 2)
  total_paye  Decimal       @db.Decimal(15, 2)
  total_net   Decimal       @db.Decimal(15, 2)
  created_at  DateTime      @default(now())
  updated_at  DateTime      @updatedAt

  payslips    EmployeePayslip[]

  @@unique([company_id, month, year])
  @@index([company_id])
  @@index([year, month])
}

model EmployeePayslip {
  id                  String      @id @default(uuid())
  payroll_run_id      String
  payroll_run         PayrollRun  @relation(fields: [payroll_run_id], references: [id], onDelete: Cascade)
  employee_id         String
  employee            Employee    @relation(fields: [employee_id], references: [id], onDelete: Cascade)
  gross_pay           Decimal     @db.Decimal(12, 2)
  basic_salary        Decimal     @db.Decimal(12, 2)
  housing_allowance    Decimal     @db.Decimal(12, 2)
  transport_allowance Decimal     @db.Decimal(12, 2)
  other_allowances    Decimal     @db.Decimal(12, 2)
  paye                Decimal     @db.Decimal(12, 2)
  pension_employee    Decimal     @db.Decimal(12, 2)
  pension_employer    Decimal     @db.Decimal(12, 2)
  nhf                 Decimal     @db.Decimal(12, 2)
  net_pay             Decimal     @db.Decimal(12, 2)
  created_at          DateTime    @default(now())

  @@index([payroll_run_id])
  @@index([employee_id])
  @@index([employee_id, created_at])
}

model Payment {
  id                  String    @id @default(uuid())
  company_id          String
  amount              Decimal   @db.Decimal(12, 2)
  plan                SubscriptionTier
  paystack_reference  String    @unique
  status              String    // success, pending, failed
  created_at          DateTime  @default(now())

  @@index([company_id])
  @@index([paystack_reference])
}

model Remittance {
  id              String    @id @default(uuid())
  company_id      String
  month           Int
  year            Int
  type            String    // PAYE, Pension, NHF, NSITF
  amount          Decimal   @db.Decimal(15, 2)
  due_date        DateTime
  remitted_at     DateTime?
  receipt_url     String?
  status          String    // pending, remitted, overdue
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  @@index([company_id])
  @@index([year, month])
}

model TaxUpdate {
  id          String    @id @default(uuid())
  title       String
  content     String    @db.Text
  tags        String[]  // PAYE, VAT, etc.
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt
}
